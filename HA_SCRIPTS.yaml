# Home Assistant Script Configuration
# =====================================
# This script simplifies logging health metrics via MQTT by encapsulating
# the API key and topic structure.
#
# Prerequisites:
# 1. Add 'hahealth_api_key' to your secrets.yaml.
# 2. Include this file in your scripts.yaml or packages configuration.

log_health_metric:
  alias: "Log Health Metric (MQTT)"
  icon: mdi:clipboard-pulse
  mode: parallel

  # Define variables here to securely resolve secrets at load time
  variables:
    # This resolves the secret once when the script is loaded
    secret_api_key: !secret hahealth_api_key

  fields:
    topic_suffix:
      description: "The specific endpoint (e.g., 'vitals', 'nutrition', 'activity')"
      example: "vitals"
    data_type:
      description: "The category string for your app"
      example: "BLOOD_PRESSURE"
    metric_data:
      description: "Object containing the actual data points"
      example: { "weight": 185, "unit": "lbs" }

  sequence:
    - action: mqtt.publish
      data:
        # Base topic is hardcoded to match the default app config
        topic: "hahealth/log/{{ topic_suffix }}"

        # We construct the master JSON object
        payload: >-
          {
            "api_key": "{{ secret_api_key }}",
            "data_type": "{{ data_type }}",
            "payload": {{ metric_data | to_json }}
          }
